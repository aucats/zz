<?php!defined('IN_SUPU') && exit('Forbidden');/* * 审核安排 */$tid = (int) getgp('tid');/* 说明:添加的 返回合同评审 */    /* @zys 2016-5-18 */    if(getgp('fanhui')){        $ct_id = getgp('fanhui');            $new_contract = array(                    'status' => 4,            );        $db->update('contract',$new_contract,array('ct_id'=>$ct_id));        $db->update('project',array('deleted'=>1),array('ct_id'=>$ct_id));        showmsg('success','success','?c=audit&a=list_wait_arrange');    }if ($step) {    //添加/修改     $tb_time = getgp('tb_time');    $te_time = getgp('te_time');    $tb_c = getgp('tb_c');    $te_c = getgp('te_c');    $tb_c && $tb_time = $tb_c;    $te_c && $te_time = $te_c;    $tb_date  = getgp('tb_date') ." ". $tb_time;    $te_date  = getgp('te_date') ." ". $te_time;	$eid=(int) getgp('eid');	$ctfrom=$db->getField("enterprises",'ctfrom',array("eid"=>$eid));    $new_task = array(        'eid' => $eid,        'ctfrom' => $ctfrom,        'tk_num' => getgp('tk_num'), //总人天        'wsqs_date' => getgp('wsqs_date'), //现场人天        // 'zb_num' => getgp('zb_num'), //准备人天        // 'sj_num' => getgp('sj_num'), //实际人天        'tb_date' => $tb_date, //开始日期        'te_date' => $te_date, //结束日期        'note' => getgp('task_note'), //备注        'self_note' => getgp('self_note'), //备注     );        /* 处理体系 */    $st_nums  = getgp('st_num');	if(!$st_nums){		echo '<script>alert("人日不能为空")</script>';		showmsg("人日不能为空","error","?c=audit&a=list_wait_arrange"); 		exit; 	}    $pids     = array_keys($st_nums);    if ($tid) {     		$_uids=$db->getCol('task_audit_team','uid',array('tid'=>$tid,'deleted'=>'0','iso_prod_type' => 0));		        $_uids = array_merge($_uids, array(            -1        ));         $tat   = $db->get_row("SELECT id,eid FROM `sp_task_audit_team` WHERE `uid` IN (" . join(",", $_uids) . ") AND ((`taskBeginDate` >= '$tb_date' AND  `taskBeginDate`<='$te_date') or ( `taskEndDate` <= '$te_date' AND `taskEndDate` >= '$tb_date') or (`taskBeginDate` <= '$tb_date' AND `taskEndDate` >= '$te_date')) AND `deleted` = '0' and iso_prod_type = 0 AND tid <>'$tid'");        //修改计划同步修改每个人的时间        if ($tat[id] and $tat[eid] != getgp('eid')) {            showmsg("有审核员时间冲突", "error", "?c=task&a=edit&tid=$tid");            exit;        }        $task->edit($tid, $new_task, 1);		$t_info=$task->get(array('id' => $tid));		if($t_info[tb_date]!=$tb_date or $t_info[te_date]!=$te_date)			$db->update("task_audit_team", array(				"taskBeginDate" => $tb_date,				"taskEndDate" => $te_date			), array(				"tid" => $tid			));        unset($tb_date, $te_date);    } else {        $tid = $task->add($new_task);		$task_info=$task->get(array('id',$tid));		log_add($task_info['eid'],0,'新增任务','',serialize($task_info));    }    if ($st_nums) {        foreach ($st_nums as $pid => $st_num) {            $audit->edit($pid, array(                'tid' => $tid,                'status' => '1',                'st_num' => $st_num //更新人天数            ));        }    }    showmsg('success', 'success', "?c=audit&a=list_wait_arrange");} else {    //取信息    $pids = getgp('pid');    $bm_8 = $bm_13 = $em_12 = $em_17 = ''; //选中使用    $tb_h = 8; //8点上午 17是下午结束时间    $te_h = 17; //8点上午 17是下午结束时间     $projects = array();    if ($pids) {        $where = " AND id IN (" . implode(',', $pids) . ")";    }elseif($tid) {        $task = load('task');        $row  = $task->get(array(            'id' => $tid        ));        extract($row, EXTR_SKIP); //获取sp_task信息         $tb_h    = date('G', strtotime($tb_date));        $te_h    = date('G', strtotime($te_date));        $tb_date = mysql2date('Y-m-d', $tb_date);        $te_date = mysql2date('Y-m-d', $te_date);        $wsqs_date = mysql2date('Y-m-d', $wsqs_date);        if($tb_date == '1970-01-01'){            $tb_date = '';        }        if($te_date == '1970-01-01'){            $te_date = '';        }        $where   = " AND tid = '$tid'";    }	${'bm_' . $tb_h} = ' selected';    ${'em_' . $te_h} = ' selected';    $eid        = 0;	/*本次安排的项目*/    $sql        = "SELECT id,eid,cti_id,ct_id,cti_code,audit_ver,tid,audit_type,st_num,iso,audit_note FROM sp_project WHERE 1 $where and iso_prod_type = 0 order by iso";    $query      = $db->query($sql);    while ($rt = $db->fetch_array($query)) {        $rt['audit_type_V'] = f_audit_type($rt['audit_type']);        $rt['audit_ver_V']  = f_audit_ver($rt['audit_ver']);        $ct_ids[]           = $rt['ct_id'];        $eid                = $rt['eid'];        $cti_info           = $db->find_one("contract_item", array('cti_id' => '$rt[cti_id]','deleted'=>0,'iso_prod_type' => 0));        if ($rt['audit_type'] == '1003') {            $sql             = "select st_num from sp_project where eid='$rt[eid]' and ct_id='$rt[ct_id]' and audit_ver='$rt[audit_ver]' and audit_type='1002' limit 1";            $rt['yijieduan'] = $db->get_var($sql); // 一阶段审核人日            $num             = $cti_info['ejdxc_num'];                    }        if ($rt['audit_type'] == '1001' || $rt['audit_type'] == '1007') {            $num = $cti_info['xcsh_num'];        }        if ($rt['audit_type'] != '1002' && $rt['audit_type'] != '1001' && $rt['audit_type'] != '1003' && $rt['audit_type'] != '1007') {            $num = $cti_info['jdxc_num'];        }        $rt['st_num'] = ($rt['st_num'] == 0.0) ? $num : $rt['st_num'];        $projects[$rt['id']] = $rt;           /* 说明:项目如果已经安排 就不能返回合同评审 */        if($rt['tid'] > 0){            $approval_disabled ='disabled';        }        $change_note[] = $rt['audit_note']; } $change_text = join("<br />",array_unique($change_note));    $pids            = array_keys($projects);	$pids            = array_merge($pids,array(-1));    if ($projects) {        $eids = $audit_types = array();        foreach ($projects as $project) {            $eids[]        = $project['eid'];            $audit_types[] = $project['audit_type'];        }        $eids = array_unique($eids);        if (count($eids) > 1)            showmsg('不同企业不能结合审核！', 'success', $REQUEST_URI);        $audit_types = array_unique($audit_types);        if (in_array('1002', $audit_types) && in_array('1003', $audit_types))            showmsg('一阶段与二阶段不能结合审核！', 'success', $REQUEST_URI);    }    $ct_ids      = array_unique($ct_ids);    $ct_id = $ct_ids[0];    $ct = $db->find_one('contract' , array("ct_id" => $ct_id) , 'combine,combine_note');    $ct_text = "结合总人日：" . $ct['combine'];    $ct_text .= "<br/>" .$ct['combine_note'];    !$tk_num && $tk_num = $ct['combine'];    /* 企业下的未安排项目 */    $ct_projects = array();    $query       = $db->query("SELECT * FROM sp_project WHERE eid ='$eid' AND id NOT IN (" . implode(',', $pids) . ") AND status IN (0,5,6) AND deleted=0 and iso_prod_type = 0  ORDER BY id DESC");    while ($rt = $db->fetch_array($query)) {        $rt['audit_type_V']     = f_audit_type($rt['audit_type']);        $rt['audit_ver_V']      = f_audit_ver($rt['audit_ver']);        $ct_projects[$rt['id']] = $rt;    }    tpl('task/edit');}?>