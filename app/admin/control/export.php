<?php!defined('IN_SUPU') && exit('Forbidden');//统计功能if( 'contract' == $a ){	$sql = "SELECT SUBSTRING(accept_date,1,4) 'Year',SUM(IF(SUBSTRING(accept_date,6,2)='01',1,0)) AS '01',SUM(IF(SUBSTRING(accept_date,6,2)='02',1,0)) AS '02',SUM(IF(SUBSTRING(accept_date,6,2)='03',1,0)) AS '03',SUM(IF(SUBSTRING(accept_date,6,2)='04',1,0)) AS '04',SUM(IF(SUBSTRING(accept_date,6,2)='05',1,0)) AS '05',SUM(IF(SUBSTRING(accept_date,6,2)='06',1,0)) AS '06',SUM(IF(SUBSTRING(accept_date,6,2)='07',1,0)) AS '07',SUM(IF(SUBSTRING(accept_date,6,2)='08',1,0)) AS '08',SUM(IF(SUBSTRING(accept_date,6,2)='09',1,0)) AS '09',SUM(IF(SUBSTRING(accept_date,6,2)='10',1,0)) AS '10',SUM(IF(SUBSTRING(accept_date,6,2)='11',1,0)) AS '11',SUM(IF(SUBSTRING(accept_date,6,2)='12',1,0)) AS '12'FROM sp_contract where accept_date != '0000-00-00' AND iso_prod_type = 0 group by SUBSTRING(accept_date,1,4); ";	$data_year = array();	for($i = 0; $i < 5; $i++) {		$data_year[] = date("Y") - $i;	}	$res = $db->query($sql);	while($row=$db->fetch_array($res)){		 		if(in_array($row['Year'], $data_year)){			$data[$row['Year']]=$row;		}	}	// 表格部分	do {		krsort($data);		$records = '';		$recid = 1;		$total = 0;		foreach($data as $key=>$value) {			$records .="		{ recid: $recid, ";			foreach($value as $month=>$score) {				if($month!='Year') {					$total += $score;					$records .="m$month: $score,  ";				}else{					$records .="year: $score,  ";				}			}			$records .="total: $total,  ";			$total = 0;			$records .="},\n";			$recid++;		}	}while(false); 	ksort($data);	$datasets = '';	foreach($data as $key=>$value) {		$data_data = 'NULL';		foreach($value as $month=>$score) {			if($month!='Year') {				$data_data .= ", ['$month', $score]";			}		}		$data_data = str_replace('NULL,', '', $data_data);		$datasets .= <<<EOT			"$key": {				label: "$key",				data: [$data_data]			},\nEOT;	}	tpl();}  elseif( 'prod_id' == $a ){	$date = date("Y");	$s_date = $date . "-01-01";	$e_date = thedate_add($s_date,1,"year");	$sql = "SELECT SUBSTRING(prod_id,1,2) 'Year',SUM(IF(SUBSTRING(s_date,6,2)='01',1,0)) AS '01',SUM(IF(SUBSTRING(s_date,6,2)='02',1,0)) AS '02',SUM(IF(SUBSTRING(s_date,6,2)='03',1,0)) AS '03',SUM(IF(SUBSTRING(s_date,6,2)='04',1,0)) AS '04',SUM(IF(SUBSTRING(s_date,6,2)='05',1,0)) AS '05',SUM(IF(SUBSTRING(s_date,6,2)='06',1,0)) AS '06',SUM(IF(SUBSTRING(s_date,6,2)='07',1,0)) AS '07',SUM(IF(SUBSTRING(s_date,6,2)='08',1,0)) AS '08',SUM(IF(SUBSTRING(s_date,6,2)='09',1,0)) AS '09',SUM(IF(SUBSTRING(s_date,6,2)='10',1,0)) AS '10',SUM(IF(SUBSTRING(s_date,6,2)='11',1,0)) AS '11',SUM(IF(SUBSTRING(s_date,6,2)='12',1,0)) AS '12'FROM sp_certificate where prod_id != '' AND s_date >= '$s_date' AND s_date < '$e_date'  AND prod_id NOT LIKE '%c%' group by SUBSTRING(prod_id,1,2); ";	/* $data_year = array();	for($i = 0; $i < 5; $i++) {		$data_year[] = date("Y") - $i;	}*/	$res = $db->query($sql);	while($row=$db->fetch_array($res)){		$data[$row['Year']]=$row;	} 	// 表格部分	// exit(p($data));	do {		// krsort($data);		$records = '';		$recid = 1;		$total = 0;		foreach($data as $key=>$value) {			$records .="		{ recid: $recid, ";			foreach($value as $month=>$score) {				if($month!='Year') {					$total += $score;					$records .="m$month: $score,  ";				}else{					$records .="year: $score,  ";				}			}			$records .="total: $total,  ";			$total = 0;			$records .="},\n";			$recid++;		}	}while(false);	// exit($records);	// $records = '';	// ksort($data);	$datasets = '';	foreach($data as $key=>$value) {		$data_data = 'NULL';		foreach($value as $month=>$score) {			if($month!='Year') {				$data_data .= ", ['$month', $score]";			}		}		$data_data = str_replace('NULL,', '', $data_data);		$datasets .= <<<EOT			"$key": {				label: "$key",				data: [$data_data]			},\nEOT;	}	 	tpl();	 	 }  elseif( 'certificate' == $a ){	$sql = "SELECT SUBSTRING(s_date,1,4) 'Year',SUM(IF(SUBSTRING(s_date,6,2)='01',1,0)) AS '01',SUM(IF(SUBSTRING(s_date,6,2)='02',1,0)) AS '02',SUM(IF(SUBSTRING(s_date,6,2)='03',1,0)) AS '03',SUM(IF(SUBSTRING(s_date,6,2)='04',1,0)) AS '04',SUM(IF(SUBSTRING(s_date,6,2)='05',1,0)) AS '05',SUM(IF(SUBSTRING(s_date,6,2)='06',1,0)) AS '06',SUM(IF(SUBSTRING(s_date,6,2)='07',1,0)) AS '07',SUM(IF(SUBSTRING(s_date,6,2)='08',1,0)) AS '08',SUM(IF(SUBSTRING(s_date,6,2)='09',1,0)) AS '09',SUM(IF(SUBSTRING(s_date,6,2)='10',1,0)) AS '10',SUM(IF(SUBSTRING(s_date,6,2)='11',1,0)) AS '11',SUM(IF(SUBSTRING(s_date,6,2)='12',1,0)) AS '12'FROM sp_certificate where s_date != '0000-00-00' group by SUBSTRING(s_date,1,4); ";	$data_year = array();	for($i = 0; $i < 5; $i++) {		$data_year[] = date("Y") - $i;	}	$res = $db->query($sql);	while($row=$db->fetch_array($res)){		if(in_array($row['Year'], $data_year)){			$data[$row['Year']]=$row;		}	}	// 表格部分	do {		krsort($data);		$records = '';		$recid = 1;		$total = 0;		foreach($data as $key=>$value) {			$records .="		{ recid: $recid, ";			foreach($value as $month=>$score) {				if($month!='Year') {					$total += $score;					$records .="m$month: $score,  ";				}else{					$records .="year: $score,  ";				}			}			$records .="total: $total,  ";			$total = 0;			$records .="},\n";			$recid++;		}	}while(false);// exit($records);	ksort($data);	$datasets = '';	foreach($data as $key=>$value) {		$data_data = 'NULL';		foreach($value as $month=>$score) {			if($month!='Year') {				$data_data .= ", ['$month', $score]";			}		}		$data_data = str_replace('NULL,', '', $data_data);		$datasets .= <<<EOT			"$key": {				label: "$key",				data: [$data_data]			},\nEOT;	}	 // $datasets = array();	 // exit(p($datasets));	tpl();	 	 } elseif( 'prod_01' == $a ){	$sql = "SELECT SUBSTRING(s_date,1,4) 'Year',SUM(IF(SUBSTRING(s_date,6,2)='01',1,0)) AS '01',SUM(IF(SUBSTRING(s_date,6,2)='02',1,0)) AS '02',SUM(IF(SUBSTRING(s_date,6,2)='03',1,0)) AS '03',SUM(IF(SUBSTRING(s_date,6,2)='04',1,0)) AS '04',SUM(IF(SUBSTRING(s_date,6,2)='05',1,0)) AS '05',SUM(IF(SUBSTRING(s_date,6,2)='06',1,0)) AS '06',SUM(IF(SUBSTRING(s_date,6,2)='07',1,0)) AS '07',SUM(IF(SUBSTRING(s_date,6,2)='08',1,0)) AS '08',SUM(IF(SUBSTRING(s_date,6,2)='09',1,0)) AS '09',SUM(IF(SUBSTRING(s_date,6,2)='10',1,0)) AS '10',SUM(IF(SUBSTRING(s_date,6,2)='11',1,0)) AS '11',SUM(IF(SUBSTRING(s_date,6,2)='12',1,0)) AS '12'FROM sp_certificate where s_date != '0000-00-00' AND LEFT(prod_id,2)='01' group by SUBSTRING(s_date,1,4); ";	$data_year = array();	for($i = 0; $i < 5; $i++) {		$data_year[] = date("Y") - $i;	}	$res = $db->query($sql);	while($row=$db->fetch_array($res)){		if(in_array($row['Year'], $data_year)){			$data[$row['Year']]=$row;		}	}	// 表格部分	do {		krsort($data);		$records = '';		$recid = 1;		$total = 0;		foreach($data as $key=>$value) {			$records .="		{ recid: $recid, ";			foreach($value as $month=>$score) {				if($month!='Year') {					$total += $score;					$records .="m$month: $score,  ";				}else{					$records .="year: $score,  ";				}			}			$records .="total: $total,  ";			$total = 0;			$records .="},\n";			$recid++;		}	}while(false);// exit($records);	ksort($data);	$datasets = '';	foreach($data as $key=>$value) {		$data_data = 'NULL';		foreach($value as $month=>$score) {			if($month!='Year') {				$data_data .= ", ['$month', $score]";			}		}		$data_data = str_replace('NULL,', '', $data_data);		$datasets .= <<<EOT			"$key": {				label: "$key",				data: [$data_data]			},\nEOT;	}	 // $datasets = array();	 // exit(p($datasets));	tpl();	 	 }  elseif( 'prod_03' == $a ){	$sql = "SELECT SUBSTRING(s_date,1,4) 'Year',SUM(IF(SUBSTRING(s_date,6,2)='01',1,0)) AS '01',SUM(IF(SUBSTRING(s_date,6,2)='02',1,0)) AS '02',SUM(IF(SUBSTRING(s_date,6,2)='03',1,0)) AS '03',SUM(IF(SUBSTRING(s_date,6,2)='04',1,0)) AS '04',SUM(IF(SUBSTRING(s_date,6,2)='05',1,0)) AS '05',SUM(IF(SUBSTRING(s_date,6,2)='06',1,0)) AS '06',SUM(IF(SUBSTRING(s_date,6,2)='07',1,0)) AS '07',SUM(IF(SUBSTRING(s_date,6,2)='08',1,0)) AS '08',SUM(IF(SUBSTRING(s_date,6,2)='09',1,0)) AS '09',SUM(IF(SUBSTRING(s_date,6,2)='10',1,0)) AS '10',SUM(IF(SUBSTRING(s_date,6,2)='11',1,0)) AS '11',SUM(IF(SUBSTRING(s_date,6,2)='12',1,0)) AS '12'FROM sp_certificate where s_date != '0000-00-00' AND LEFT(prod_id,2)='03' group by SUBSTRING(s_date,1,4); ";	$data_year = array();	for($i = 0; $i < 5; $i++) {		$data_year[] = date("Y") - $i;	}	$res = $db->query($sql);	while($row=$db->fetch_array($res)){		if(in_array($row['Year'], $data_year)){			$data[$row['Year']]=$row;		}	}	// 表格部分	do {		krsort($data);		$records = '';		$recid = 1;		$total = 0;		foreach($data as $key=>$value) {			$records .="		{ recid: $recid, ";			foreach($value as $month=>$score) {				if($month!='Year') {					$total += $score;					$records .="m$month: $score,  ";				}else{					$records .="year: $score,  ";				}			}			$records .="total: $total,  ";			$total = 0;			$records .="},\n";			$recid++;		}	}while(false);// exit($records);	ksort($data);	$datasets = '';	foreach($data as $key=>$value) {		$data_data = 'NULL';		foreach($value as $month=>$score) {			if($month!='Year') {				$data_data .= ", ['$month', $score]";			}		}		$data_data = str_replace('NULL,', '', $data_data);		$datasets .= <<<EOT			"$key": {				label: "$key",				data: [$data_data]			},\nEOT;	}	 // $datasets = array();	 // exit(p($datasets));	tpl();	 	 }  elseif( 'prod_10' == $a ){	$sql = "SELECT SUBSTRING(s_date,1,4) 'Year',SUM(IF(SUBSTRING(s_date,6,2)='01',1,0)) AS '01',SUM(IF(SUBSTRING(s_date,6,2)='02',1,0)) AS '02',SUM(IF(SUBSTRING(s_date,6,2)='03',1,0)) AS '03',SUM(IF(SUBSTRING(s_date,6,2)='04',1,0)) AS '04',SUM(IF(SUBSTRING(s_date,6,2)='05',1,0)) AS '05',SUM(IF(SUBSTRING(s_date,6,2)='06',1,0)) AS '06',SUM(IF(SUBSTRING(s_date,6,2)='07',1,0)) AS '07',SUM(IF(SUBSTRING(s_date,6,2)='08',1,0)) AS '08',SUM(IF(SUBSTRING(s_date,6,2)='09',1,0)) AS '09',SUM(IF(SUBSTRING(s_date,6,2)='10',1,0)) AS '10',SUM(IF(SUBSTRING(s_date,6,2)='11',1,0)) AS '11',SUM(IF(SUBSTRING(s_date,6,2)='12',1,0)) AS '12'FROM sp_certificate where s_date != '0000-00-00' AND LEFT(prod_id,2)='10' group by SUBSTRING(s_date,1,4); ";	$data_year = array();	for($i = 0; $i < 5; $i++) {		$data_year[] = date("Y") - $i;	}	$res = $db->query($sql);	while($row=$db->fetch_array($res)){		if(in_array($row['Year'], $data_year)){			$data[$row['Year']]=$row;		}	}	// 表格部分	do {		krsort($data);		$records = '';		$recid = 1;		$total = 0;		foreach($data as $key=>$value) {			$records .="		{ recid: $recid, ";			foreach($value as $month=>$score) {				if($month!='Year') {					$total += $score;					$records .="m$month: $score,  ";				}else{					$records .="year: $score,  ";				}			}			$records .="total: $total,  ";			$total = 0;			$records .="},\n";			$recid++;		}	}while(false);// exit($records);	ksort($data);	$datasets = '';	foreach($data as $key=>$value) {		$data_data = 'NULL';		foreach($value as $month=>$score) {			if($month!='Year') {				$data_data .= ", ['$month', $score]";			}		}		$data_data = str_replace('NULL,', '', $data_data);		$datasets .= <<<EOT			"$key": {				label: "$key",				data: [$data_data]			},\nEOT;	}	 // $datasets = array();	 // exit(p($datasets));	tpl();	 	 }  else if($a=='report'){	$s_date = getgp('s_date');	$e_date = getgp('e_date');	tpl( 'export/report' );} else if($a=='plan_report'){	tpl( 'export/plan' );} else if($a=='prod_report'){	tpl( 'export/prod' );} else if($a=='year_report'){	$date_e = getgp('date_e');	$s_zizheng = getgp('s_zizheng');	$s_kind = getgp('s_kind');	if($date_e){		$where =" AND z.s_date <= '$date_e' and z.deleted=0";	}	$sql = "select z.status,e.areacode ,z.audit_ver,z.iso,cti.audit_code from sp_certificate z left join sp_enterprises e on e.eid=z.eid left join sp_contract_item cti on cti.cti_id=z.cti_id where z.status in('01','02','03','04') and z.deleted=0 and   `main_certno` = ''   AND z.is_check='y' $where";	$res = $db->query($sql);	while($row = $db->fetch_array($res)){		$datas[$row['audit_ver']][(int)$row['status']]++;		if($row[status]!='01') continue;		$datas[substr($row['areacode'],0,2).'0000'][$row['iso']]++;			if($row['audit_code']){			$row['audit_code']=str_replace(';','；',$row['audit_code']);			$arr = explode('；',$row['audit_code']);			$temp='';			foreach($arr as $value){				if($temp!=substr($value, 0,2)){					$datas[substr($value, 0,2)][$row['iso']]++;					$temp=substr($value, 0,2);				}			}								}	}	tpl( 'export/year_report' );} else if($a=='auditor_report'){	$s_date = getgp('s_date');	$e_date = getgp('e_date');	if(!$s_date){		$s_date = date("Y").'-01-01';	}	if(!$e_date){		$e_date = date("Y").'-12-31';	}	tpl( 'export/auditor_report' );}else{	tpl("export/$a");}?>