<?php!defined('IN_SUPU') && exit('Forbidden');//生成的缓存类型/*$cache_types = array( 'nature', 'industry', 'arctype','statecode', 'currency', 'card_type',					'political', 'technical', 'education', 'qualification', 'skill_source',					'job_type', 'department', 'attachtype', 'audit_role', 'iso', 'audit_ver',					'audit_type', 'risk_level', 'mark', 'certstate', 'certpasue', 'certrecall',					'union_type', 'site_type', 'cost_type','ep_type','ep_level',					'region','ct_type','choose_type','insurance','certreplace','certchange',					'audit_job',//是否专职					'evaluation_methods',//评价方式					'post',//评价方式					'business',//业务设置					'functions',//职能设置					'employment_methods',//用工方式					'employment_nature',//聘用性质					'area',// 区域设置					'send_company', //快递公司					'class', //课程设置					'question', //课程设置					'fl_question', //课程设置					 'auditor_arctype',//审核员文档类型					'audit_person',					'add_basis',					'exc_basis',					'pasuequs',					'recalqus',					'sp_f',					'use_role', 					 );*///生成的缓存类型,sp_settings->type$cache_types=$db->get_col("SELECT DISTINCT type FROM sp_settings where deleted=0");if( $a=='index'){	$nav_title='系统设置';	$role_groups = $db->find_results("settings",array('type'=>'use_role'));	tpl('setting/index');}elseif('com' == $a){	tpl('../../com/view/setting/index'); } elseif( 'list' == $a ) {	$type = trim( getgp( 'type' ) );	$resdb = array();	$query = $db->query( "SELECT * FROM sp_settings WHERE type = '$type' AND deleted=0 ORDER BY vieworder ASC,code ASC" );	while( $rt = $db->fetch_array( $query ) ){		$resdb[$rt['id']] = $rt;	} 	tpl('setting/list');}elseif('role_set' == $a){					//单个权限组设置	$action = CTL_DIR .'setting/' . $a . '.php';    include_once ($action);}elseif('save_role' == $a){   $check_sys = getgp('check_sys');//p($check_sys);	$gro_id = (int)getgp('gro_id');		//获取分组权限ID	$role = @ implode("|||",$check_sys);	//echo $role;   //exit;	$value = '';	if($gro_id){		$value=array(			'other' => $role,		);		$db->update('settings',$value,array('id'=>$gro_id));			$REQUEST_URI="?c=setting&a=role_set&gro_id=$gro_id&type=use_role";		showmsg( 'success', 'success', $REQUEST_URI );	}else{		echo 'error';	}} elseif( 'save' == $a ) {	$source = trim( getgp( 'source' ) );	$type = trim( getgp( 'type' ) );	$codes = array_map( 'trim', getgp( 'code' ) );	$names = array_map( 'trim', getgp( 'name' ) );	$order = array_map( 'intval', getgp( 'vieworder' ) );	$is_stops = array_map( 'intval', getgp( 'is_stop' ) );	$old_settings = array();	$query = $db->query("SELECT * FROM sp_settings WHERE type = '$type'");	while( $rt = $db->fetch_array( $query ) ){		$olds[$rt['id']] = $rt;	}	if( $names ){		foreach( $names as $id => $name ){			if( $name != $olds[$id]['name'] || $codes[$id] != $olds[$id]['code'] || $is_stops[$id] != $olds[$id]['is_stop'] || $order[$id] != $olds[$id]['vieworder'] ){				$db->query("UPDATE sp_settings SET code = '{$codes[$id]}', type = '$type',					name = '{$names[$id]}',					is_stop = '{$is_stops[$id]}',					vieworder = '{$order[$id]}' WHERE id = '$id'");			}		}	}	$new = getgp( 'new' );	if( $new ){		$ADDSQL = array();		foreach( $new['name'] as $key => $val ){			if( !$val ) continue;			$name = $val;			$code = $new['code'][$key];			$is_stop = (int)$new['is_stop'][$key];			$vieworder = $new['vieworder'][$key];			$ADDSQL[] = "('$type', '$code','$name','$vieworder','$is_stop')";		}		if( $ADDSQL ){			$add_sql = "INSERT INTO sp_settings ( type, code, name, vieworder, is_stop ) VALUES " . implode(',', $ADDSQL );			$db->query( $add_sql );		}	}	update_cache( $type );	showmsg( 'success', 'success', "?c=$c&a=$source&type=$type" );}elseif('del'==$a){  	$db->update( 'settings', array( 'deleted' => '1' ), array( 'id' => $_GET['id']) );	update_cache(  $_GET['type']);	showmsg( 'success', 'success', "?c=$c&a=$_GET[to]&type=$_GET[type]" );}elseif('cache_all' == $a){			//体系    生成所有缓存	foreach($cache_types as $v){		update_cache($v);	}	update_ver_cache();				//生成版本：标准	update_ctfrom();				//合同来源	showmsg( 'success', 'success', "?c=setting" );}elseif('com_cache_all' == $a){		//产品    生成所有缓存	foreach($cache_types as $v){		update_cache($v);	}	showmsg( 'success', 'success', "?c=setting&a=com" );}