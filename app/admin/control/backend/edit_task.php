<?php!defined('IN_SUPU') && exit('Forbidden');$tid = (int) getgp('tid');if ($_POST) {    $task = load('task');    if ($auditor = $_POST['auditor']) {        $uid = $db->getField('hr', 'id', array(            "name" => $auditor['name'],            'is_hire' => 1        ));        if (!$uid) {            showmsg("人员不存在！", "error");        }        $t_info  = $task->get(array(            'id' => $tid        ));        $tb_date = $t_info['tb_date'];        $te_date = $t_info['te_date'];        $tat     = $db->get_var("SELECT id,eid FROM `sp_task_audit_team` WHERE `uid` = $uid AND ((`taskBeginDate` >= '$tb_date' AND  `taskBeginDate`<='$te_date') or ( `taskEndDate` <= '$te_date' AND `taskEndDate` >= '$tb_date') or (`taskBeginDate` <= '$tb_date' AND `taskEndDate` >= '$te_date')) AND `deleted` = '0' and iso_prod_type = 0 AND tid <>'$tid'");        if ($tat) {            showmsg("人员时间冲突！", "error");        }        $query = $db->query("SELECT * FROM sp_project WHERE deleted = 0 AND tid = $tid");        while ($rt = $db->fetch_array($query)) {            $rt['audit_code'] = str_replace([';',','],'；', $rt['audit_code']);            $_code = explode("；", $rt['audit_code']);            $hac   = $db->get_row("SELECT qua_type , GROUP_CONCAT(audit_code) audit_code FROM  sp_hr_audit_code  WHERE deleted = 0 AND  uid = $uid AND  iso = '$rt[iso]' AND audit_code IN ('" . join("','", $_code) . "')");            // echo $db->sql;            // p($hac);            // exit;            if (!$hac['qua_type']) {                showmsg("没有资格" ,"error");                                }            $new_auditor = array(                'pid' => $rt['id'],                'tid' => $rt['tid'],                'eid' => $rt['eid'],                'uid' => $uid,                'name' => $auditor[name],                'ctfrom' => $rt[ctfrom],                'audit_ver' => $rt[audit_ver],                'iso' => $rt[iso],                'audit_type' => $rt[audit_type],                'role' => $auditor['role'],                'qua_type' => $hac['qua_type'],                'audit_code' => str_replace(",", "；", $hac['audit_code']),                'use_code' => str_replace(",", "；", $hac['audit_code']),                'taskBeginDate' => $tb_date,                'taskEndDate' => $te_date,                'witness' => 0 ,                 'witness_person' => ''            );            $db->insert('task_audit_team', $new_auditor);        }        unset($query, $rt);        showmsg("success", "success", "?c=backend&a=edit_task&tid=$tid");    }    $tb_time = getgp('tb_time');    $te_time = getgp('te_time');    $tb_c    = getgp('tb_c');    $te_c    = getgp('te_c');    $tb_c && $tb_time = $tb_c;    $te_c && $te_time = $te_c;    $tb_date  = getgp('tb_date') . " " . $tb_time;    $te_date  = getgp('te_date') . " " . $te_time;    $eid      = (int) getgp('eid');    $new_task = array(        'tk_num' => getgp('tk_num'),        'wsqs_date' => getgp('wsqs_date'),        'tb_date' => $tb_date,        'te_date' => $te_date,        'note' => getgp('task_note'),        'self_note' => getgp('self_note'),        'approval_user' => getgp('approval_user'),        'approval_date' => getgp('approval_date'),        'create_user' => getgp('create_user'),        'create_date' => getgp('create_date'),    );    $_uids    = $db->getCol('task_audit_team', 'uid', array(        'tid' => $tid,        'deleted' => '0',        'iso_prod_type' => 0    ));    $_uids    = array_merge($_uids, array(        -1    ));    $tat      = $db->get_row("SELECT id,eid FROM `sp_task_audit_team` WHERE `uid` IN (" . join(",", $_uids) . ") AND ((`taskBeginDate` >= '$tb_date' AND  `taskBeginDate`<='$te_date') or ( `taskEndDate` <= '$te_date' AND `taskEndDate` >= '$tb_date') or (`taskBeginDate` <= '$tb_date' AND `taskEndDate` >= '$te_date')) AND `deleted` = '0' and iso_prod_type = 0 AND tid <>'$tid'");    if ($tat[id] and $tat[eid] != getgp('eid')) {        showmsg("有审核员时间冲突", "error");        exit;    }    $task->edit($tid, $new_task, 1);    $t_info = $task->get(array(        'id' => $tid    ));    if ($t_info[tb_date] != $tb_date or $t_info[te_date] != $te_date)        $db->update("task_audit_team", array(            "taskBeginDate" => $tb_date,            "taskEndDate" => $te_date        ), array(            "tid" => $tid        ));    unset($tb_date, $te_date);    showmsg('success', 'success', "?c=backend&a=list_task");} else {    $bm_8 = $bm_13 = $em_12 = $em_17 = '';    $task = load('task');    $row  = $task->get(array(        'id' => $tid    ));    extract($row, EXTR_SKIP);    $tb_h      = date('G', strtotime($tb_date));    $te_h      = date('G', strtotime($te_date));    $tb_date   = mysql2date('Y-m-d', $tb_date);    $te_date   = mysql2date('Y-m-d', $te_date);    $wsqs_date = mysql2date('Y-m-d', $wsqs_date);    if ($tb_date == '1970-01-01') {        $tb_date = '';    }    if ($te_date == '1970-01-01') {        $te_date = '';    }    $where           = " AND tid = '$tid'";    ${'bm_' . $tb_h} = ' selected';    ${'em_' . $te_h} = ' selected';    $eid             = 0;    $sql             = "SELECT id,eid,cti_id,ct_id,cti_code,audit_ver,tid,audit_type,st_num,iso,audit_note FROM sp_project WHERE 1 $where and iso_prod_type = 0 order by iso";    $query           = $db->query($sql);    while ($rt = $db->fetch_array($query)) {        $rt['audit_type_V']  = f_audit_type($rt['audit_type']);        $rt['audit_ver_V']   = f_audit_ver($rt['audit_ver']);        $ct_ids[]            = $rt['ct_id'];        $eid                 = $rt['eid'];        $projects[$rt['id']] = $rt;        $ct_id               = $rt['ct_id'];    }    $ct_projects = array();    $query       = $db->query("SELECT * FROM sp_project WHERE eid ='$eid'  AND status IN (0,5,6) AND deleted=0 and iso_prod_type = 0  ORDER BY id DESC");    while ($rt = $db->fetch_array($query)) {        $rt['audit_type_V']     = f_audit_type($rt['audit_type']);        $rt['audit_ver_V']      = f_audit_ver($rt['audit_ver']);        $ct_projects[$rt['id']] = $rt;    }    $auditor = $db->get_results("SELECT * FROM sp_task_audit_team WHERE tid = $tid AND deleted = 0 GROUP BY uid");    tpl();}?>